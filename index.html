
<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="google-site-verification" content="VkGEZbIgX7ZPSXiBtOSXHzRS6n5vR7ydW3WdnO9S_bI" />
<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>OCR image-only PDF files. | OCR-image-only-PDF-files</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="OCR image-only PDF files." />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="https://gstolarov.github.io/OCR-image-only-PDF-files/" />
<meta property="og:url" content="https://gstolarov.github.io/OCR-image-only-PDF-files/" />
<meta property="og:site_name" content="OCR-image-only-PDF-files" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="OCR image-only PDF files." />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebSite","headline":"OCR image-only PDF files.","name":"OCR-image-only-PDF-files","url":"https://gstolarov.github.io/OCR-image-only-PDF-files/"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/OCR-image-only-PDF-files/assets/css/style.css?v=6010e581e9605fd8ed690baa4b6abe7c48ca5058">
    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/OCR-image-only-PDF-files/favicon.ico" -->

<!-- end custom head snippets -->

  </head>
  <body>
    <div class="container-lg px-3 my-5 markdown-body">
      
      <h1><a href="https://gstolarov.github.io/OCR-image-only-PDF-files/">OCR-image-only-PDF-files</a></h1>
      

      <h1 id="ocr-image-only-pdf-files">OCR image-only PDF files.</h1>

<h2 id="introduction">Introduction</h2>
<p>The purpose of this article is to show how OCR information can be added to scanned, image-only PDFs. The benefit of this approach is that the files can be indexed by standard Adobe/Microsoft iFilters but also the text can be selected using visual tools (Adobe Reader, Chome, Edge, …)</p>

<h2 id="background">Background</h2>
<p>I needed to add OCR information to thousands of PDF files (stored actually in the SQL server). I wanted to create a script/utility that could be executed daily to index any new PDF files that don’t already contain searchable text.  After searching for a while I found a recipe:</p>
<ul>
  <li>Use ghostscript to extract individual pages from PDF to image (JPG) files</li>
  <li>Use Tesseract to extract OCR from images</li>
  <li>Store extracted text back to PDF</li>
</ul>

<h2 id="take-1">Take 1</h2>
<p>Apparently since I touched Tesseract last time in 2009, they added a new feature: the image and the OCR text will be exported as PDF file. I think you need Tesseract version 4+. So the solution seems pretty simple and following batch file emerged within next 20 min (see ocr.bat in the attached project):</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>set gs="C:\Program Files\gs\gs9.52\bin\gswin64c.exe"
set tesseract="C:\Program Files\Tesseract-OCR\tesseract.exe"

if '%1'=='' goto :badParams
if '%2'=='' goto :badParams
mkdir %temp%\ocr\
set nm=%~n1
SETLOCAL ENABLEDELAYEDEXPANSION 

rem split pdf into multiple jpeg
%gs% -dSAFER -dBATCH -dNOPAUSE -sDEVICE=jpeg -r300 -dTextAlphaBits=4 -o "%temp%\ocr\ocr_%nm%_%%04d.jpg" -f "%1"

rem ocr each jpeg
for %%i in (%temp%\ocr\ocr_%nm%_*.jpg) do %tesseract% -l eng "%%i" %%~pni pdf
del %temp%\ocr\ocr_%nm%_*.jpg

rem combine pdfs
set ff=#
for %%i in (%temp%\ocr\ocr_%nm%_*.pdf) do set ff=!ff! %%i
set ff=%ff:#=%
%gs% -dNOPAUSE -dQUIET -dBATCH -dNOPAUSE -q -sDEVICE=pdfwrite -o "%2" %ff%
del %temp%\ocr\ocr_%nm%_*.pdf

goto :eof

:badParams
echo usage %0 pdf-In pdf-Out
</code></pre></div></div>
<p>As you can see the script does following</p>
<ul>
  <li>Uses GhostScript to extract individual pages into the %temp%\ocr####.jpg files</li>
  <li>For each of the JPG file run Tesseract to create a %temp%\ocr####.pdf file</li>
  <li>Use ghost script to combine all PDF files into the output file.</li>
</ul>

<h2 id="take-1-problems">Take 1 Problems</h2>
<p>Very quickly the problems with solution 1 arose for large PDF files (10+ pages)</p>

<ul>
  <li>It was pretty slow. But I figured, since it’s running as a background process only for a new files, may be I can live with this.</li>
  <li>The output file was much, much, much larger then source - like 4 times. Times thousands of files - became a show stopper.</li>
</ul>

<h2 id="take-2---hocr2pdf">Take 2 - HOCR2PDF</h2>
<p>Other people have the same problem. Enter HOCR2PDF (https://archive.codeplex.com/?p=hocrtopdf). Apparently Tesseract, aside from outputting OCR as text or PDF, can also output results as HOCR files - effectively encoded HTML files. So the task changes slightly</p>

<ul>
  <li>Use GhostScript to split PDF files into multiple JPGs</li>
  <li>Use tesseract to convert JPGs into HOCR files</li>
  <li>Parse HOCR files</li>
  <li>Use PDF library (iTextShart) to add text information to the output PDF</li>
</ul>

<h2 id="take-2---problems">Take 2 - Problems</h2>
<p>Well, HOCR2PDF had similar problems as my original script. It was still slow and files were still pretty large, even though about half the size of solution #1.</p>

<p>#Take 3 - Final
So I went ahead and created my own project.</p>

<p>After some troubleshooting, and performance improvements such as enabling compression, using single font for a whole page, I found out that the size bloat boils down to a single iTextShart function call</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>stamp.GetImportedPage(stamp.Reader, pg)
</code></pre></div></div>
<p>That call alone seems to add about 30K per page. And the only reason it’s needed is to get page height. After replacing this call with</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>stamp.Reader.GetPageSizeWithRotation(pg).Height
</code></pre></div></div>
<p>the size bloat went away, and the output file to my surprise became actually smaller then the source (probably due to enabling compression and removing unsused object).</p>

<p>To address performance problem I decided to run Tesseract for each page concurrently, using ThreadPool. For large (10+ pages) file, the performance boost was drastic.</p>

<h2 id="using-the-code">Using the code</h2>
<p>The project contains a class PdfOcr with one public method OcrFile. The usage as below:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>string txt = new PdfOcr().OcrFile(fileIn, fileOut);
</code></pre></div></div>

<p>This code will OCR the fileIn pdf file, create fileOut and return OCR text. The class might need to be customised by changing/assigning to following static variables:</p>
<ul>
  <li>GhostScript - location of GhostScript executable</li>
  <li>Tesseract - location of Tesseract executable.</li>
  <li>wdiTemp - folder where temp files will be generated</li>
  <li>tmpPrfx - prefix for all the temp files
The class is stored in Program.cs file along with the main program that takes 2 arguments - source and destination file names.</li>
</ul>

<h2 id="points-of-interest">Points of Interest</h2>
<ul>
  <li>https://github.com/UB-Mannheim/tesseract/wiki - TesserAct windows binary</li>
  <li>https://www.ghostscript.com/download/gsdnld.html - GhostScript binary download.</li>
  <li>https://archive.codeplex.com/?p=hocrtopdf - HOCR2PDF .NET utility</li>
</ul>


      
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js" integrity="sha256-lZaRhKri35AyJSypXXs4o6OPFTbTmUoltBbDCbdzegg=" crossorigin="anonymous"></script>
    <script>anchors.add();</script>
  </body>
</html>
